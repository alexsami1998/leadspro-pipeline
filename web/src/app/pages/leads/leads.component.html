<div class="leads-container">
  <div class="leads-header">
    <h1>Gest√£o de Leads</h1>
    <p>--</p>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Carregando leads...</p>
  </div>

  <!-- Main Content -->
  <div class="leads-content" *ngIf="!loading">
    <!-- Actions Bar -->
    <div class="actions-bar">
      <div class="search-filters">
        <div class="search-box">
          <input
            type="text"
            placeholder="Buscar leads..."
            [(ngModel)]="searchTerm"
            (input)="filterLeads()"
            class="search-input"
          />
        </div>

        <div class="filters">
          <select [(ngModel)]="selectedStatus" (change)="filterLeads()" class="filter-select">
            <option value="">Todos os Status</option>
            <option *ngFor="let status of Object.values(LeadStatus)" [value]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>

          <select [(ngModel)]="selectedSource" (change)="filterLeads()" class="filter-select">
            <option value="">Todas as Fontes</option>
            <option *ngFor="let source of Object.values(LeadSource)" [value]="source">
              {{ getSourceLabel(source) }}
            </option>
          </select>

          <button (click)="clearFilters()" class="btn btn-outline">
            üîÑ Limpar Filtros
          </button>
        </div>
      </div>

      <div class="actions">
        <button (click)="openPdfExportModal()" class="btn btn-success">
          üìÑ Exportar PDF
        </button>
        <button (click)="openCreateModal()" class="btn btn-primary" *ngIf="canEditLeads()">
          ‚ûï Novo Lead
        </button>
      </div>
    </div>

    <!-- Results Info -->
    <div class="results-info">
      <span>{{ filteredLeads.length }} lead(s) encontrado(s)</span>
    </div>

    <!-- Leads Grid -->
    <div class="leads-grid" *ngIf="filteredLeads.length > 0">
      <div class="lead-card" *ngFor="let lead of filteredLeads">
        <div class="lead-header">
          <div class="lead-avatar">
            <span>{{ lead.nome.charAt(0) }}</span>
          </div>
          <div class="lead-info">
            <h3>{{ lead.nome }}</h3>
            <p class="lead-email">{{ lead.email }}</p>
            <p class="lead-phone">{{ lead.telefone }}</p>
          </div>
          <div class="lead-actions">
            <button (click)="openWhatsApp(lead)" class="btn-icon" title="Enviar WhatsApp">
              üì±
            </button>
            <button (click)="openEditModal(lead)" class="btn-icon" title="Editar" *ngIf="canEditLeads()">
              ‚úèÔ∏è
            </button>
            <button (click)="deleteLead(lead)" class="btn-icon btn-danger" title="Excluir" *ngIf="canDeleteLeads()">
              üóëÔ∏è
            </button>
          </div>
        </div>

        <div class="lead-details">
          <div class="detail-row">
            <span class="label">Empresa:</span>
            <span class="value">{{ lead.empresa || 'N√£o informado' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Cargo:</span>
            <span class="value">{{ lead.cargo || 'N√£o informado' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Fonte:</span>
            <span class="value source-badge">{{ getSourceLabel(lead.fonte) }}</span>
          </div>
          <div class="detail-row" *ngIf="canViewContractValues()">
            <span class="label">Valor:</span>
            <span class="value">{{ formatCurrency(lead.valorContrato) }}</span>
          </div>
          <div class="detail-row" *ngIf="lead.produtos && lead.produtos.length > 0">
            <span class="label">Produtos:</span>
            <span class="value">{{ lead.produtos.length }} produto(s)</span>
          </div>
          <div class="detail-row" *ngIf="lead.valorTotal && lead.valorTotal > 0">
            <span class="label">Valor Total:</span>
            <span class="value total-value">{{ formatCurrency(lead.valorTotal) }}</span>
          </div>
        </div>

        <div class="lead-status">
          <span class="status-badge" [style.background-color]="getStatusColor(lead.status)">
            {{ getStatusLabel(lead.status) }}
          </span>
        </div>

        <div class="lead-footer">
          <div class="lead-date">
            Criado em: {{ formatDate(lead.dataCriacao) }}
          </div>
          <div class="lead-actions-footer">
            <button (click)="openInteractionModal(lead)" class="btn btn-sm">
              üí¨ Intera√ß√£o
            </button>
                         <div class="status-actions" *ngIf="canEditLeads()">
               <select (change)="onStatusChange($event, lead)" class="status-select">
                 <option value="">Mudar Status</option>
                 <option *ngFor="let status of Object.values(LeadStatus)" [value]="status">
                   {{ getStatusLabel(status) }}
                 </option>
               </select>
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredLeads.length === 0 && !loading">
      <div class="empty-icon">üìã</div>
      <h3>Nenhum lead encontrado</h3>
      <p>N√£o h√° leads que correspondam aos filtros aplicados.</p>
      <button (click)="clearFilters()" class="btn btn-primary">
        Limpar Filtros
      </button>
    </div>
  </div>

  <!-- Create Lead Modal -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeModals()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Novo Lead</h2>
        <button (click)="closeModals()" class="btn-close">‚úï</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="createLead()">
          <div class="form-group">
            <label for="nome">Nome *</label>
            <input type="text" id="nome" [(ngModel)]="newLead.nome" name="nome" required class="form-input">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="email">Email *</label>
              <input type="email" id="email" [(ngModel)]="newLead.email" name="email" required class="form-input">
            </div>
            <div class="form-group">
              <label for="telefone">Telefone *</label>
              <input type="text" id="telefone" [(ngModel)]="newLead.telefone" name="telefone" required class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="empresa">Empresa</label>
              <input type="text" id="empresa" [(ngModel)]="newLead.empresa" name="empresa" class="form-input">
            </div>
            <div class="form-group">
              <label for="cargo">Cargo</label>
              <input type="text" id="cargo" [(ngModel)]="newLead.cargo" name="cargo" class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="fonte">Fonte *</label>
              <select id="fonte" [(ngModel)]="newLead.fonte" name="fonte" required class="form-input">
                <option *ngFor="let source of Object.values(LeadSource)" [value]="source">
                  {{ getSourceLabel(source) }}
                </option>
              </select>
            </div>
            <div class="form-group" *ngIf="canViewContractValues()">
              <label for="valorContrato">Valor do Contrato</label>
              <input type="number" id="valorContrato" [(ngModel)]="newLead.valorContrato" name="valorContrato" step="0.01" class="form-input">
            </div>
          </div>

          <div class="form-group">
            <label for="observacoes">Observa√ß√µes</label>
            <textarea id="observacoes" [(ngModel)]="newLead.observacoes" name="observacoes" rows="3" class="form-input"></textarea>
          </div>

          <!-- Se√ß√£o de Produtos -->
          <div class="products-section">
            <div class="section-header">
              <h3>Produtos</h3>
              <button type="button" (click)="addProductToNewLead()" class="btn btn-outline btn-sm" [disabled]="newLeadProducts.length >= 6">
                ‚ûï Adicionar Produto
              </button>
            </div>

            <div class="products-list" *ngIf="newLeadProducts.length > 0">
              <div class="product-item" *ngFor="let product of newLeadProducts; let i = index">
                <div class="product-row">
                  <div class="form-group">
                    <label>Produto</label>
                    <select [(ngModel)]="product.nome" (change)="onProductChangeNewLead(i)" class="form-input">
                      <option *ngFor="let availableProduct of getAvailableProductsForNewLead(i)" [value]="availableProduct">
                        {{ getProductLabel(availableProduct) }}
                      </option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label>Valor</label>
                    <input type="number" [(ngModel)]="product.valor" (input)="onProductChangeNewLead(i)" step="0.01" min="0" class="form-input">
                  </div>
                  
                  <div class="form-group">
                    <label>Desconto</label>
                    <input type="number" [(ngModel)]="product.desconto" (input)="onProductChangeNewLead(i)" step="0.01" min="0" class="form-input">
                  </div>
                  
                  <div class="form-group">
                    <label>Valor Final</label>
                    <input type="number" [value]="product.valorFinal" readonly class="form-input readonly">
                  </div>
                  
                  <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" (click)="removeProductFromNewLead(i)" class="btn btn-danger btn-sm">üóëÔ∏è</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group" *ngIf="newLeadProducts.length > 0">
              <label for="descontoGeral">Desconto Geral</label>
              <input type="number" id="descontoGeral" [(ngModel)]="newLead.descontoGeral" (input)="onDescontoGeralChangeNewLead()" name="descontoGeral" step="0.01" min="0" class="form-input">
            </div>

            <div class="total-section" *ngIf="newLeadProducts.length > 0">
              <div class="total-display">
                <strong>Valor Total: {{ formatCurrency(newLead.valorTotal || 0) }}</strong>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" (click)="closeModals()" class="btn btn-secondary">Cancelar</button>
            <button type="submit" class="btn btn-primary">Criar Lead</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Lead Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeModals()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Editar Lead</h2>
        <button (click)="closeModals()" class="btn-close">‚úï</button>
      </div>
      
      <!-- Tabs Navigation -->
      <div class="modal-tabs">
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'details'"
          (click)="activeTab = 'details'"
        >
          üìù Detalhes
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'interactions'"
          (click)="activeTab = 'interactions'"
        >
          üí¨ Intera√ß√µes ({{ leadInteractions.length }})
        </button>
      </div>

      <!-- Tab Content -->
      <div class="modal-body">
        <!-- Details Tab -->
        <div class="tab-content" *ngIf="activeTab === 'details' && editLead">
          <form (ngSubmit)="updateLead()">
            <div class="form-group">
              <label for="edit-nome">Nome *</label>
              <input type="text" id="edit-nome" [(ngModel)]="editLead.nome" name="nome" required class="form-input">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="edit-email">Email *</label>
                <input type="email" id="edit-email" [(ngModel)]="editLead.email" name="email" required class="form-input">
              </div>
              <div class="form-group">
                <label for="edit-telefone">Telefone *</label>
                <input type="text" id="edit-telefone" [(ngModel)]="editLead.telefone" name="telefone" required class="form-input">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="edit-empresa">Empresa</label>
                <input type="text" id="edit-empresa" [(ngModel)]="editLead.empresa" name="empresa" class="form-input">
              </div>
              <div class="form-group">
                <label for="edit-cargo">Cargo</label>
                <input type="text" id="edit-cargo" [(ngModel)]="editLead.cargo" name="cargo" class="form-input">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="edit-fonte">Fonte *</label>
                <select id="edit-fonte" [(ngModel)]="editLead.fonte" name="fonte" required class="form-input">
                  <option *ngFor="let source of Object.values(LeadSource)" [value]="source">
                    {{ getSourceLabel(source) }}
                  </option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-status">Status *</label>
                <select id="edit-status" [(ngModel)]="editLead.status" name="status" required class="form-input">
                  <option *ngFor="let status of Object.values(LeadStatus)" [value]="status">
                    {{ getStatusLabel(status) }}
                  </option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group" *ngIf="canViewContractValues()">
                <label for="edit-valorContrato">Valor do Contrato</label>
                <input type="number" id="edit-valorContrato" [(ngModel)]="editLead.valorContrato" name="valorContrato" step="0.01" class="form-input">
              </div>
            </div>

            <div class="form-group">
              <label for="edit-observacoes">Observa√ß√µes</label>
              <textarea id="edit-observacoes" [(ngModel)]="editLead.observacoes" name="observacoes" rows="3" class="form-input"></textarea>
            </div>

            <!-- Se√ß√£o de Produtos -->
            <div class="products-section">
              <div class="section-header">
                <h3>Produtos</h3>
                <button type="button" (click)="addProductToEditLead()" class="btn btn-outline btn-sm" [disabled]="editLeadProducts.length >= 6">
                  ‚ûï Adicionar Produto
                </button>
              </div>

              <div class="products-list" *ngIf="editLeadProducts.length > 0">
                <div class="product-item" *ngFor="let product of editLeadProducts; let i = index">
                  <div class="product-row">
                    <div class="form-group">
                      <label>Produto</label>
                      <select [(ngModel)]="product.nome" (change)="onProductChangeEditLead(i)" class="form-input">
                        <option *ngFor="let availableProduct of getAvailableProductsForEditLead(i)" [value]="availableProduct">
                          {{ getProductLabel(availableProduct) }}
                        </option>
                      </select>
                    </div>
                    
                    <div class="form-group">
                      <label>Valor</label>
                      <input type="number" [(ngModel)]="product.valor" (input)="onProductChangeEditLead(i)" step="0.01" min="0" class="form-input">
                    </div>
                    
                    <div class="form-group">
                      <label>Desconto</label>
                      <input type="number" [(ngModel)]="product.desconto" (input)="onProductChangeEditLead(i)" step="0.01" min="0" class="form-input">
                    </div>
                    
                    <div class="form-group">
                      <label>Valor Final</label>
                      <input type="number" [value]="product.valorFinal" readonly class="form-input readonly">
                    </div>
                    
                    <div class="form-group">
                      <label>&nbsp;</label>
                      <button type="button" (click)="removeProductFromEditLead(i)" class="btn btn-danger btn-sm">üóëÔ∏è</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group" *ngIf="editLeadProducts.length > 0">
                <label for="edit-descontoGeral">Desconto Geral</label>
                <input type="number" id="edit-descontoGeral" [(ngModel)]="editLead.descontoGeral" (input)="onDescontoGeralChangeEditLead()" name="descontoGeral" step="0.01" min="0" class="form-input">
              </div>

              <div class="total-section" *ngIf="editLeadProducts.length > 0">
                <div class="total-display">
                  <strong>Valor Total: {{ formatCurrency(editLead.valorTotal || 0) }}</strong>
                </div>
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" (click)="closeModals()" class="btn btn-secondary">Cancelar</button>
              <button type="submit" class="btn btn-primary">Atualizar Lead</button>
            </div>
          </form>
        </div>

        <!-- Interactions Tab -->
        <div class="tab-content" *ngIf="activeTab === 'interactions' && editLead">
          <div class="interactions-header">
            <h3>Hist√≥rico de Intera√ß√µes</h3>
            <button (click)="openInteractionModal(editLead!)" class="btn btn-primary btn-sm" *ngIf="editLead">
              ‚ûï Nova Intera√ß√£o
            </button>
          </div>

          <div class="interactions-list" *ngIf="leadInteractions.length > 0">
            <div class="interaction-item" *ngFor="let interaction of leadInteractions">
              <div class="interaction-header">
                <span class="interaction-type">{{ getInteractionTypeLabel(interaction.tipo) }}</span>
                <span class="interaction-date">{{ formatDate(interaction.dataCriacao) }}</span>
              </div>
              <div class="interaction-content">
                {{ interaction.conteudo }}
              </div>
              
              <!-- M√≠dia da intera√ß√£o -->
              <div class="interaction-media" *ngIf="interaction.mediaId">
                <div class="media-item">
                  <div class="media-preview-small" *ngIf="interaction.mediaType && isImageType(interaction.mediaType)">
                    <img [src]="getMediaUrl(interaction.mediaId)" 
                         [alt]="interaction.mediaFilename"
                         (click)="openMediaModal(interaction)"
                         class="media-thumbnail"
                         (error)="onImageError($event)"
                         (load)="onImageLoad()">
                    <div class="media-actions">
                      <button (click)="openMediaModal(interaction)" class="btn-view-media" title="Visualizar em tamanho maior">
                        üîç
                      </button>
                      <button (click)="downloadMedia(interaction)" class="btn-download-media" title="Baixar imagem">
                        üì•
                      </button>
                    </div>
                  </div>
                  <div class="media-document" *ngIf="interaction.mediaType && !isImageType(interaction.mediaType)">
                    <div class="document-preview" (click)="downloadMedia(interaction)">
                      <div class="document-icon">üìÑ</div>
                      <div class="document-details">
                        <p class="document-name">{{ interaction.mediaFilename }}</p>
                        <p class="document-type">{{ getFileTypeLabel(interaction.mediaType) }}</p>
                      </div>
                    </div>
                  </div>
                  <button (click)="downloadMedia(interaction)" class="btn-download-media" title="Baixar arquivo">
                    üì•
                  </button>
                </div>
              </div>
              
              <div class="interaction-user">
                Por: {{ interaction.usuarioCriacao }}
              </div>
            </div>
          </div>

          <div class="empty-interactions" *ngIf="leadInteractions.length === 0">
            <p>Nenhuma intera√ß√£o registrada para este lead.</p>
            <button (click)="openInteractionModal(editLead!)" class="btn btn-primary" *ngIf="editLead">
              Registrar Primeira Intera√ß√£o
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Interaction Modal -->
  <div class="modal-overlay" *ngIf="showInteractionModal" (click)="closeModals()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Nova Intera√ß√£o</h2>
        <button (click)="closeModals()" class="btn-close">‚úï</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="addInteraction()">
          <div class="form-group">
            <label for="interaction-tipo">Tipo de Intera√ß√£o *</label>
            <select id="interaction-tipo" [(ngModel)]="newInteraction.tipo" name="tipo" required class="form-input">
              <option *ngFor="let tipo of Object.values(InteractionType)" [value]="tipo">
                {{ tipo.replace('_', ' ').toLowerCase() }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="interaction-conteudo">Conte√∫do *</label>
            <textarea id="interaction-conteudo" [(ngModel)]="newInteraction.conteudo" name="conteudo" rows="4" required class="form-input" placeholder="Descreva a intera√ß√£o realizada..."></textarea>
          </div>

          <!-- Upload de M√≠dia -->
          <div class="form-group">
            <label>Anexar M√≠dia (Opcional)</label>
            <div class="media-upload-container">
              <div class="media-upload-area" 
                   [class.dragover]="isDragOver"
                   (dragover)="onDragOver($event)"
                   (dragleave)="onDragLeave($event)"
                   (drop)="onDrop($event)"
                   (click)="fileInput.click()">
                <div class="upload-content">
                  <div class="upload-icon">üìé</div>
                  <p class="upload-text">
                    <span *ngIf="!selectedFile">Clique aqui ou arraste um arquivo</span>
                    <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
                  </p>
                  <p class="upload-hint">Imagens, PDFs e documentos (m√°x. 10MB)</p>
                </div>
              </div>
              <input #fileInput type="file" 
                     (change)="onFileSelected($event)"
                     accept="image/*,.pdf,.doc,.docx"
                     style="display: none;">
              
              <!-- Preview da m√≠dia selecionada -->
              <div class="media-preview" *ngIf="selectedFile">
                <div class="preview-content">
                  <div class="preview-image" *ngIf="isImageFile(selectedFile)">
                    <img [src]="mediaPreviewUrl" [alt]="selectedFile.name">
                  </div>
                  <div class="preview-document" *ngIf="!isImageFile(selectedFile)">
                    <div class="document-icon">üìÑ</div>
                    <div class="document-info">
                      <p class="document-name">{{ selectedFile.name }}</p>
                      <p class="document-size">{{ formatFileSize(selectedFile.size) }}</p>
                    </div>
                  </div>
                  <button type="button" (click)="removeSelectedFile()" class="btn-remove-file">‚úï</button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" (click)="closeModals()" class="btn btn-secondary">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="uploadingMedia">
              <span *ngIf="!uploadingMedia">Registrar Intera√ß√£o</span>
              <span *ngIf="uploadingMedia">‚è≥ Enviando...</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Media Modal -->
  <div class="modal-overlay" *ngIf="showMediaModal" (click)="closeMediaModal()">
    <div class="modal media-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ selectedMediaInteraction?.mediaFilename }}</h2>
        <button (click)="closeMediaModal()" class="btn-close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="media-viewer" *ngIf="selectedMediaInteraction">
          <div class="media-image" *ngIf="selectedMediaInteraction.mediaType && isImageType(selectedMediaInteraction.mediaType)">
            <div class="image-container">
              <img [src]="getMediaUrl(selectedMediaInteraction.mediaId || '')" 
                   [alt]="selectedMediaInteraction.mediaFilename"
                   class="full-size-image"
                   [class.zoomed]="isImageZoomed">
            </div>
            <div class="media-controls">
              <button (click)="toggleImageZoom()" class="btn-control" title="Ampliar/Reduzir">
                {{ isImageZoomed ? 'üîç-' : 'üîç+' }}
              </button>
              <button (click)="downloadMedia(selectedMediaInteraction)" class="btn-control" title="Baixar imagem">
                üì•
              </button>
              <span class="media-info">{{ selectedMediaInteraction.mediaFilename }}</span>
            </div>
          </div>
          <div class="media-document" *ngIf="selectedMediaInteraction.mediaType && !isImageType(selectedMediaInteraction.mediaType)">
            <div class="document-viewer">
              <div class="document-icon-large">üìÑ</div>
              <h3>{{ selectedMediaInteraction.mediaFilename }}</h3>
              <p class="document-type">{{ getFileTypeLabel(selectedMediaInteraction.mediaType) }}</p>
              <button (click)="downloadMedia(selectedMediaInteraction)" class="btn btn-primary">
                üì• Baixar Arquivo
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Exporta√ß√£o PDF -->
  <div class="modal-overlay" *ngIf="showPdfExportModal" (click)="closePdfExportModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <app-pdf-export 
        (export)="onPdfExportSuccess()"
        (cancel)="closePdfExportModal()">
      </app-pdf-export>
    </div>
  </div>
</div>
